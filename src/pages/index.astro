---
import TemplateSelect from '../components/TemplateSelect.astro';
import TextPreview from '../components/TextPreview.astro';
import ShareButtons from '../components/ShareButtons.astro';
import yaml from 'js-yaml';
import templatesYamlRaw from '../data/templates.yaml?raw';

// Load templates at build time (like pa_mi_senti)
const templates = (() => {
  try {
    const data = yaml.load(templatesYamlRaw);
    const allTemplates = Array.isArray(data) ? data : [];
    // Filter only active templates
    return allTemplates.filter(template => template.active !== false);
  } catch (error) {
    console.error('Error parsing templates.yaml:', error);
    return [];
  }
})();
---

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Trasforma link condivisi in messaggi curati secondo template personalizzabili" />
  <meta name="theme-color" content="#3b82f6" />

  <title>Riformula</title>

  <link rel="manifest" href="/in_due_tocchi/manifest.webmanifest" />
  <link rel="icon" type="image/svg+xml" href="/in_due_tocchi/favicon.svg" />
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <header class="mb-8 text-center">
      <h1 class="text-4xl font-bold text-gray-900 mb-2">Riformula</h1>
      <p class="text-gray-600">Trasforma link in messaggi curati</p>
    </header>

    <!-- Main content -->
    <main>
      <TemplateSelect />
      <ShareButtons />
      <TextPreview />
    </main>

    <!-- Footer -->
    <footer class="mt-12 text-center text-sm text-gray-500">
      <p>Riformula v1.0 - PWA Offline-First</p>
    </footer>
  </div>

  <script is:inline set:html={`
    // Templates loaded at build time, embedded as JSON
    // Using direct JSON assignment instead of define:vars for better Android compatibility
    window.DEFAULT_TEMPLATES = ${JSON.stringify(templates)};
  `}></script>

  <script>
    import {
      applyTemplate
    } from '../lib/templates.js';

    import {
      parseSharedData,
      isSharedContent,
      clearSharedDataFromUrl,
      shareText,
      copyToClipboard,
      canShare
    } from '../lib/share.js';

    // Get templates from inline script
    const DEFAULT_TEMPLATES = window.DEFAULT_TEMPLATES || [];

    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/in_due_tocchi/sw.js')
          .then(registration => {
            console.log('Service Worker registered:', registration);
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      });
    }

    // App state
    let currentTemplateId = null;
    let currentData = { title: '', text: '', url: '' };
    let isPopulating = false; // Flag to prevent event handlers during populate

    // DOM elements
    const templateButtons = document.getElementById('template-buttons');
    const previewText = document.getElementById('preview-text');
    const charCount = document.getElementById('char-count');
    const appendUrlCheckbox = document.getElementById('append-url-checkbox');

    const inputTitle = document.getElementById('input-title');
    const inputText = document.getElementById('input-text');
    const inputUrl = document.getElementById('input-url');


    const shareBtn = document.getElementById('share-btn');
    const copyBtn = document.getElementById('copy-btn');
    const feedbackMessage = document.getElementById('feedback-message');

    // Initialize
    function init() {
      // Check if content was shared
      if (isSharedContent()) {
        currentData = parseSharedData();
        populateInputs();
        clearSharedDataFromUrl();
      }

      // Load templates into select
      loadTemplates();

      // Update preview
      updatePreview();

      // Show/hide share button based on API availability
      if (!canShare()) {
        shareBtn.style.display = 'none';
      }
    }

    // Load templates as buttons
    function loadTemplates() {
      templateButtons.innerHTML = '';

      DEFAULT_TEMPLATES.forEach((template, index) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'template-btn flex flex-col items-center justify-center p-4 rounded-xl bg-gray-50 border-2 border-gray-200 text-gray-800 font-medium shadow-sm hover:bg-gray-100 active:bg-gray-200 transition-colors';
        button.dataset.templateId = template.id;

        button.innerHTML = `
          <span class="text-3xl mb-2">${template.emoji}</span>
          <span class="text-sm text-center">${template.name}</span>
        `;

        button.addEventListener('click', () => selectTemplate(template.id));

        templateButtons.appendChild(button);

        if (index === 0) {
          currentTemplateId = template.id;
          updateButtonStyles();
        }
      });
    }

    // Select a template
    function selectTemplate(templateId) {
      currentTemplateId = templateId;
      updateButtonStyles();
      updatePreview();
    }

    // Update button styles based on selection
    function updateButtonStyles() {
      const buttons = templateButtons.querySelectorAll('.template-btn');
      buttons.forEach(button => {
        const isSelected = button.dataset.templateId === currentTemplateId;
        if (isSelected) {
          button.classList.remove('bg-gray-50', 'border-gray-200', 'text-gray-800');
          button.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
        } else {
          button.classList.remove('bg-blue-50', 'border-blue-200', 'text-blue-800');
          button.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-800');
        }
      });
    }

    // Get template by ID
    function getTemplate(id) {
      return DEFAULT_TEMPLATES.find(t => t.id === id);
    }

    // Populate input fields with current data
    function populateInputs() {
      isPopulating = true;
      inputTitle.value = currentData.title;
      inputText.value = currentData.text;
      inputUrl.value = currentData.url;
      isPopulating = false;
    }

    // Update current data from inputs
    function updateDataFromInputs() {
      currentData = {
        title: inputTitle.value,
        text: inputText.value,
        url: inputUrl.value
      };
    }

    // Update preview text
    function updatePreview() {
      const template = getTemplate(currentTemplateId);
      if (!template) return;

      const appendUrl = appendUrlCheckbox.checked;
      const result = applyTemplate(template.template, currentData, appendUrl);

      previewText.value = result;
      charCount.textContent = `${result.length} caratteri`;
    }

    // Show feedback message
    function showFeedback(message, type = 'success') {
      feedbackMessage.textContent = message;
      feedbackMessage.className = `mt-4 p-3 rounded-lg ${
        type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
      }`;
      feedbackMessage.classList.remove('hidden');

      setTimeout(() => {
        feedbackMessage.classList.add('hidden');
      }, 3000);
    }


    // Event listeners

    inputTitle.addEventListener('input', () => {
      if (!isPopulating) {
        updateDataFromInputs();
        updatePreview();
      }
    });

    inputText.addEventListener('input', () => {
      if (!isPopulating) {
        updateDataFromInputs();
        updatePreview();
      }
    });

    inputUrl.addEventListener('input', () => {
      if (!isPopulating) {
        updateDataFromInputs();
        updatePreview();
      }
    });

    appendUrlCheckbox.addEventListener('change', updatePreview);

    shareBtn.addEventListener('click', async () => {
      const text = previewText.value;
      if (!text) {
        showFeedback('Nessun testo da condividere', 'error');
        return;
      }

      const success = await shareText(text, 'Riformula');
      if (success) {
        showFeedback('Testo condiviso con successo');
      } else {
        // Fallback to copy
        const copied = await copyToClipboard(text);
        if (copied) {
          showFeedback('Condivisione non disponibile. Testo copiato negli appunti');
        } else {
          showFeedback('Errore durante la condivisione', 'error');
        }
      }
    });

    copyBtn.addEventListener('click', async () => {
      const text = previewText.value;
      if (!text) {
        showFeedback('Nessun testo da copiare', 'error');
        return;
      }

      const success = await copyToClipboard(text);
      if (success) {
        showFeedback('Testo copiato negli appunti');
      } else {
        showFeedback('Errore durante la copia', 'error');
      }
    });

    // Initialize app
    init();
  </script>
</body>
</html>
