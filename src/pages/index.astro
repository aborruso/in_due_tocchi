---
import TemplateSelect from '../components/TemplateSelect.astro';
import TextPreview from '../components/TextPreview.astro';
import ShareButtons from '../components/ShareButtons.astro';
import SiteFooter from '../components/SiteFooter.astro';
import LanguageSelector from '../components/LanguageSelector.astro';
import yaml from 'js-yaml';
import templatesYamlRaw from '../data/templates.yaml?raw';
import releaseNotesYamlRaw from '../data/release-notes.yaml?raw';
import { getSeoData, OG_LOCALES, OG_IMAGE_ALT } from '../lib/seo.js';

// Load templates at build time (like pa_mi_senti)
const templates = (() => {
  try {
    const data = yaml.load(templatesYamlRaw);
    const allTemplates = Array.isArray(data) ? data : [];
    // Filter only active templates
    return allTemplates.filter(template => template.active !== false);
  } catch (error) {
    console.error('Error parsing templates.yaml:', error);
    return [];
  }
})();

function escapeHtml(value = '') {
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function formatInlineMarkdown(text = '') {
  const escaped = escapeHtml(text);
  return escaped
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.+?)`/g, '<code>$1</code>');
}

function simpleMarkdownToHtml(markdown = '') {
  if (!markdown) return '';

  const lines = markdown.split(/\r?\n/);
  const htmlParts = [];
  let inList = false;

  const closeList = () => {
    if (inList) {
      htmlParts.push('</ul>');
      inList = false;
    }
  };

  lines.forEach(line => {
    const trimmed = line.trim();

    if (!trimmed) {
      closeList();
      return;
    }

    if (/^[-\u2022]\s+/.test(trimmed)) {
      if (!inList) {
        htmlParts.push('<ul class="release-modal-list">');
        inList = true;
      }
      const content = formatInlineMarkdown(trimmed.replace(/^[-\u2022]\s+/, ''));
      htmlParts.push(`<li>${content}</li>`);
    } else {
      closeList();
      const content = formatInlineMarkdown(trimmed);
      htmlParts.push(`<p>${content}</p>`);
    }
  });

  closeList();
  return htmlParts.join('');
}

const releaseNotes = (() => {
  try {
    const data = yaml.load(releaseNotesYamlRaw);
    const rawNotes = Array.isArray(data) ? data : [];
    return rawNotes
      .filter(note => note && note.id && note.version && note.title)
      .map(note => ({
        id: note.id,
        version: String(note.version),
        title: note.title,
        lang: note.lang || null,
        bodyHtml: simpleMarkdownToHtml(note.body || '')
      }));
  } catch (error) {
    console.error('Error parsing release-notes.yaml:', error);
    return [];
  }
})();

const { meta: pageSeo, pageUrl, imageUrl } = getSeoData('home', Astro);
const primaryLocale = OG_LOCALES.it;
const alternateLocales = Object.entries(OG_LOCALES)
  .filter(([lang]) => lang !== 'it')
  .map(([, locale]) => locale);
---

<!DOCTYPE html>
<html lang="it" id="html-root">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content={pageSeo.translations.it.description} />
  <meta name="theme-color" content="#3b82f6" />

  <title id="page-title">{pageSeo.translations.it.title}</title>

  <meta property="og:type" content={pageSeo.type} />
  <meta property="og:url" content={pageUrl} />
  <meta property="og:site_name" content="ShareForge" />
  <meta property="og:image" content={imageUrl} />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:alt" content={OG_IMAGE_ALT} />
  {primaryLocale && <meta property="og:locale" content={primaryLocale} />}
  {alternateLocales.map(locale => (
    <meta property="og:locale:alternate" content={locale} key={`og-locale-${locale}`} />
  ))}
  {Object.entries(pageSeo.translations).flatMap(([lang, data]) => [
    <meta property="og:title" content={data.title} lang={lang} key={`og-title-${lang}`} />,
    <meta property="og:description" content={data.description} lang={lang} key={`og-desc-${lang}`} />
  ])}

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={pageUrl} />
  <meta name="twitter:image" content={imageUrl} />
  <meta name="twitter:image:alt" content={OG_IMAGE_ALT} />
  {Object.entries(pageSeo.translations).flatMap(([lang, data]) => [
    <meta name="twitter:title" content={data.title} lang={lang} key={`tw-title-${lang}`} />,
    <meta name="twitter:description" content={data.description} lang={lang} key={`tw-desc-${lang}`} />
  ])}

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700;800&family=IBM+Plex+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <link rel="manifest" href="/in_due_tocchi/manifest.webmanifest" />
  <link rel="icon" type="image/svg+xml" href="/in_due_tocchi/favicon.svg" />

  <style>
    #release-modal-body ul {
      list-style: disc;
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }

    #release-modal-body li {
      margin-bottom: 0.35rem;
      line-height: 1.4;
    }

    #release-modal-body p {
      margin-bottom: 0.75rem;
      line-height: 1.5;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col pb-28">
  <div class="container mx-auto px-4 py-4 max-w-4xl flex-1">
    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-center justify-between gap-3">
        <div class="text-left">
          <h1 class="text-3xl font-display font-extrabold text-gray-900 mb-1" data-i18n="header.title">ShareForge</h1>
          <p class="text-sm font-medium text-gray-600" data-i18n="header.subtitle">Trasforma link in messaggi curati</p>
        </div>
        <div class="flex items-center gap-2">
          <LanguageSelector />
          <button id="menu-btn" class="text-2xl text-gray-600 hover:text-gray-900 transition-colors p-2" aria-label="Menu">
            â‰¡
          </button>
        </div>
      </div>

      <!-- Dropdown Menu -->
      <div id="menu-dropdown" class="hidden bg-white rounded-lg shadow-md border border-gray-200 p-2 text-right mt-2">
        <a href="/in_due_tocchi/templates" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded transition-colors font-medium">
          <span>ðŸ“‹</span> <span data-i18n="common.templates">Template</span>
        </a>
        <a href="/in_due_tocchi/mobile" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded transition-colors font-medium">
          <span>ðŸ“–</span> <span data-i18n="common.guide">Guida</span>
        </a>
      </div>
    </header>

    <!-- Mobile Help Banner -->
    <div id="mobile-help-banner" class="hidden bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6 shadow-sm">
      <div class="flex items-start justify-between gap-3">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-2xl">ðŸ“²</span>
            <h3 class="font-display font-bold text-blue-900" data-i18n="mobileHelp.title">Come si usa ShareForge?</h3>
          </div>
          <ol class="list-decimal list-inside space-y-1 text-sm text-blue-800 mb-3">
            <li data-i18n="mobileHelp.step1">Condividi un link da un'altra app</li>
            <li data-i18n="mobileHelp.step2">Scegli un template</li>
            <li data-i18n="mobileHelp.step3">Invia al tuo LLM preferito</li>
          </ol>
          <a href="/in_due_tocchi/mobile#come-funziona" class="inline-block text-sm font-semibold text-blue-600 hover:text-blue-800 underline" data-i18n="mobileHelp.guideLink">
            Vedi guida completa â†’
          </a>
        </div>
        <button id="dismiss-mobile-help" class="text-blue-600 hover:text-blue-800 font-bold text-xl leading-none p-1" aria-label="Chiudi">
          Ã—
        </button>
      </div>
    </div>

    <!-- Main content -->
    <main>
      <TemplateSelect />
      <TextPreview />
      <ShareButtons />
    </main>

    <SiteFooter class="mt-8" />
  </div>

  <!-- Sticky Bottom Bar with Share Buttons -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
    <div class="container mx-auto px-4 py-3 max-w-4xl">
      <div id="share-buttons-container" class="flex gap-2">
        <button
          id="share-btn"
          class="flex-1 px-4 py-3 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition-colors shadow-sm hover:shadow-md flex items-center justify-center gap-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
          </svg>
          <span data-i18n="common.share">Condividi</span>
        </button>

        <button
          id="copy-btn"
          class="flex-1 px-4 py-3 bg-gray-500 text-white text-sm font-medium rounded-lg hover:bg-gray-600 transition-colors shadow-sm hover:shadow-md flex items-center justify-center gap-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
          </svg>
          <span data-i18n="common.copy">Copia</span>
        </button>
      </div>

      <!-- Feedback message -->
      <div
        id="feedback-message"
        class="mt-2 p-2 rounded-lg hidden text-xs text-center"
      ></div>
    </div>
  </div>

  <!-- Device Warning Modal -->
  <div id="device-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-8 max-w-md mx-4 shadow-xl">
      <div class="text-center">
        <div class="text-5xl mb-4">ðŸ“±</div>
        <h3 class="text-lg font-display font-extrabold text-gray-900 mb-4" data-i18n="deviceModal.title">Quest'app funziona meglio su smartphone Android</h3>

        <div class="text-left mb-6">
          <p class="font-semibold text-gray-800 mb-2" data-i18n="deviceModal.instructions">Per usarla:</p>
          <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
            <li data-i18n="deviceModal.step1">Apri questo link da Chrome Android</li>
            <li data-i18n="deviceModal.step2">Installa l'app (Chrome menu â†’ "Installa app")</li>
            <li data-i18n="deviceModal.step3">Condividi link da qualsiasi app â†’ seleziona ShareForge</li>
          </ol>
        </div>

        <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
          <p class="text-sm font-semibold text-gray-800 mb-3" data-i18n="deviceModal.qrTitle">Scansiona con Chrome Android</p>
          <div class="flex justify-center">
            <canvas id="qr-canvas" class="border border-gray-300 rounded"></canvas>
          </div>
        </div>

        <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-4 text-left">
          <p class="text-sm text-gray-700">
            <strong>Usi desktop?</strong> Scopri come usare ShareForge con un bookmarklet â†’
            <a href="/in_due_tocchi/desktop" class="text-blue-600 hover:text-blue-800 underline font-semibold">Guida desktop</a>
          </p>
        </div>

        <div class="flex flex-col gap-3">
          <a href="/in_due_tocchi/mobile" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold text-center transition-colors" data-i18n="deviceModal.learnMore">
            Guida completa
          </a>
          <button id="dismiss-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium transition-colors" data-i18n="common.close">
            Chiudi
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Notification Banner -->
  <div id="update-banner" class="fixed top-0 left-0 right-0 bg-blue-500 text-white p-4 shadow-lg z-40 hidden">
    <div class="container mx-auto flex items-center justify-between max-w-4xl">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ðŸ”„</span>
        <span class="font-medium" data-i18n="updateBanner.message">Nuova versione disponibile!</span>
      </div>
      <button id="reload-app" class="bg-white text-blue-500 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition-colors" data-i18n="updateBanner.update">
        Aggiorna ora
      </button>
    </div>
  </div>

  <!-- Release Notes Modal -->
  <div
    id="release-modal"
    class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 px-4 hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="release-modal-title"
  >
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 flex flex-col gap-5">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-blue-600 mb-1" data-i18n="releaseModal.badge">NovitÃ </p>
          <h3 id="release-modal-title" class="text-2xl font-display font-extrabold text-gray-900" data-i18n="releaseModal.placeholderTitle">
            Cosa cambia in questa versione
          </h3>
          <p class="text-sm text-gray-500 mt-1">
            <span data-i18n="releaseModal.versionLabel">Versione</span>
            <span id="release-modal-version" class="font-semibold text-gray-800 ml-1">â€”</span>
          </p>
        </div>
        <button id="release-modal-close" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">
          Ã—
          <span class="sr-only" data-i18n="releaseModal.close">Chiudi</span>
        </button>
      </div>
      <div id="release-modal-body" class="text-sm text-gray-700 space-y-4"></div>
      <button id="release-modal-cta" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl px-4 py-3 transition-colors" data-i18n="releaseModal.cta">
        Ho capito
      </button>
    </div>
  </div>

  <script is:inline set:html={`
    // Templates loaded at build time, embedded as JSON
    // Using direct JSON assignment instead of define:vars for better Android compatibility
    window.DEFAULT_TEMPLATES = ${JSON.stringify(templates)};
    window.RELEASE_NOTES = ${JSON.stringify(releaseNotes)};
  `}></script>

  <script>
    import {
      applyTemplate,
      getTemplateOrder,
      saveTemplateOrder,
      resetTemplateOrder
    } from '../lib/templates.js';

    import {
      parseSharedData,
      isSharedContent,
      clearSharedDataFromUrl,
      shareText,
      copyToClipboard,
      canShare
    } from '../lib/share.js';

    import {
      detectLanguage,
      getCurrentLanguage,
      setLanguage,
      setTranslations,
      t
    } from '../lib/i18n.js';

    import { translations } from '../lib/translations.js';
    import QRCode from 'qrcode';

    // Get templates from inline script
    let ALL_TEMPLATES = [];
    let ALL_RELEASE_NOTES = [];
    const RELEASE_STORAGE_KEY = 'shareforge-release-version';
    let DEFAULT_TEMPLATES = []; // Will be filtered by language
    let activeReleaseNote = null;

    // Initialize i18n
    setTranslations(translations);

    function bootstrapStaticData() {
      ALL_TEMPLATES = Array.isArray(window.DEFAULT_TEMPLATES) ? window.DEFAULT_TEMPLATES : [];
      ALL_RELEASE_NOTES = Array.isArray(window.RELEASE_NOTES) ? window.RELEASE_NOTES : [];
    }

    // Function to filter templates by current language
    function getTemplatesForLanguage(lang) {
      return ALL_TEMPLATES.filter(t => t.lang === lang || !t.lang); // Include templates without lang field for backward compatibility
    }

    function getReleaseNotesForLanguage(lang) {
      const localizedNotes = ALL_RELEASE_NOTES.filter(note => note.lang === lang);
      if (localizedNotes.length) {
        return localizedNotes;
      }

      return ALL_RELEASE_NOTES.filter(note => !note.lang);
    }

    function getLatestReleaseNote() {
      const lang = getCurrentLanguage();
      const notes = getReleaseNotesForLanguage(lang);
      return notes.length ? notes[0] : null;
    }

    function hasSeenRelease(version) {
      if (!version) return true;

      try {
        const storedVersion = localStorage.getItem(RELEASE_STORAGE_KEY);
        return storedVersion === version;
      } catch (error) {
        console.warn('localStorage not available for release modal check:', error);
        return false;
      }
    }

    function markReleaseAsSeen(version) {
      if (!version) return;

      try {
        localStorage.setItem(RELEASE_STORAGE_KEY, version);
      } catch (error) {
        console.warn('localStorage not available for release modal persistence:', error);
      }
    }

    function renderReleaseModal(note) {
      if (!note) return;

      if (releaseModalTitle) {
        releaseModalTitle.textContent = note.title;
      }

      if (releaseModalVersion) {
        releaseModalVersion.textContent = note.version || '';
      }

      if (releaseModalBody) {
        releaseModalBody.innerHTML = note.bodyHtml || '';
      }
    }

    function openReleaseModal(note) {
      if (!note || !releaseModal) return;
      activeReleaseNote = note;
      renderReleaseModal(note);
      releaseModal.classList.remove('hidden');
    }

    function closeReleaseModal() {
      if (releaseModal) {
        releaseModal.classList.add('hidden');
      }

      if (activeReleaseNote && activeReleaseNote.version) {
        markReleaseAsSeen(activeReleaseNote.version);
      }

      activeReleaseNote = null;
    }

    function syncReleaseModalWithLanguage() {
      const note = getLatestReleaseNote();
      if (!note) return;

      if (
        activeReleaseNote &&
        activeReleaseNote.version === note.version &&
        releaseModal &&
        !releaseModal.classList.contains('hidden')
      ) {
        activeReleaseNote = note;
        renderReleaseModal(note);
        return;
      }

      if (!hasSeenRelease(note.version)) {
        const deviceModalElement = document.getElementById('device-modal');
        if (deviceModalElement && !deviceModalElement.classList.contains('hidden')) {
          return;
        }
        openReleaseModal(note);
      }
    }

    // Function to update all i18n elements
    function updateI18n() {
      const lang = getCurrentLanguage();

      // Update templates for current language
      DEFAULT_TEMPLATES = getTemplatesForLanguage(lang);

      // Update html lang attribute
      const htmlRoot = document.getElementById('html-root');
      if (htmlRoot) {
        htmlRoot.setAttribute('lang', lang);
      }

      // Update all elements with data-i18n attribute
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      // Update all elements with data-i18n-html attribute (for HTML content)
      // SECURITY NOTE: innerHTML is used here with translation strings.
      // This is safe because translations are bundled at build time from trusted sources (translations.js).
      // NEVER use this pattern with user-generated content or runtime-loaded strings.
      document.querySelectorAll('[data-i18n-html]').forEach(el => {
        const key = el.getAttribute('data-i18n-html');
        el.innerHTML = t(key);
      });

      // Update placeholders
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        el.placeholder = t(key);
      });

      // Update language selector active state
      updateLanguageSelectorState();

      // Reload templates with current language
      loadTemplates();

      // Update dynamic content
      updatePreview();

      // Update release notes modal for current language/version
      syncReleaseModalWithLanguage();
    }

    // Function to update language selector button states
    function updateLanguageSelectorState() {
      const lang = getCurrentLanguage();
      document.querySelectorAll('.lang-btn').forEach(btn => {
        if (btn.getAttribute('data-lang') === lang) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Language selector event listener
    document.addEventListener('click', (e) => {
      const langBtn = e.target.closest('.lang-btn');
      if (langBtn) {
        const newLang = langBtn.getAttribute('data-lang');
        setLanguage(newLang);

        // Clear current selection when changing language
        currentTemplateId = null;

        updateI18n();
        showFeedback(t('languageSelector.label') + ': ' + t(`languageSelector.${newLang}`));
      }
    });

    // Register service worker
    if ('serviceWorker' in navigator) {
      let refreshing = false;

      // Reload when new SW takes control
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        console.log('[App] New Service Worker activated, reloading...');
        window.location.reload();
      });

      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/in_due_tocchi/sw.js')
          .then(registration => {
            console.log('Service Worker registered:', registration);

            // Force immediate update check on registration
            registration.update();

            // Check for updates periodically (every 1 minute for faster updates)
            setInterval(() => {
              registration.update();
            }, 60 * 1000);

            // When new SW is waiting, skip waiting immediately
            if (registration.waiting) {
              registration.waiting.postMessage({ type: 'SKIP_WAITING' });
            }

            // Listen for new SW waiting
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New SW is waiting, tell it to skip waiting
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                  }
                });
              }
            });
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      });

      // Listen for service worker updates (optional, for logging)
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'SW_UPDATED') {
          console.log('New version available:', event.data.version);
        }
      });
    }

    // Show update banner
    function showUpdateBanner() {
      const banner = document.getElementById('update-banner');
      if (banner) {
        banner.classList.remove('hidden');
      }
    }

    // Reload app button handler
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'reload-app') {
        window.location.reload();
      }
    });

    // Device detection and modal logic
    function isAndroidMobile() {
      const userAgent = navigator.userAgent;
      return /Android/i.test(userAgent) && /Mobile/i.test(userAgent);
    }

    function shouldShowDeviceModal() {
      try {
        return !isAndroidMobile() && !localStorage.getItem('deviceModalDismissed');
      } catch (e) {
        console.warn('localStorage not available for device modal check:', e);
        return !isAndroidMobile();
      }
    }

    async function showDeviceModal() {
      const modal = document.getElementById('device-modal');
      if (modal) {
        modal.classList.remove('hidden');

        // Generate QR code with current page URL
        const qrCanvas = document.getElementById('qr-canvas');
        if (qrCanvas) {
          try {
            const currentUrl = window.location.href;
            await QRCode.toCanvas(qrCanvas, currentUrl, {
              width: 180,
              margin: 1,
              color: {
                dark: '#000000',
                light: '#FFFFFF'
              }
            });
          } catch (error) {
            console.error('Error generating QR code:', error);
          }
        }
      }
    }

    function hideDeviceModal() {
      const modal = document.getElementById('device-modal');
      if (modal) {
        modal.classList.add('hidden');
        try {
          localStorage.setItem('deviceModalDismissed', 'true');
        } catch (e) {
          console.warn('localStorage not available for dismissing device modal:', e);
        }

        syncReleaseModalWithLanguage();
      }
    }

    // Show modal if needed
    if (shouldShowDeviceModal()) {
      // Delay to ensure DOM is ready
      setTimeout(showDeviceModal, 1000);
    }

    // App state
    let currentTemplateId = null;
    let currentData = { title: '', text: '', url: '' };
    let isPopulating = false; // Flag to prevent event handlers during populate
    let orderedTemplates = []; // Ordered templates from storage
    let draggedElement = null;

    // DOM elements - declare early before any usage
    const templateButtons = document.getElementById('template-buttons');
    const previewText = document.getElementById('preview-text');
    const charCount = document.getElementById('char-count');
    const appendUrlCheckbox = document.getElementById('append-url-checkbox');

    const inputTitle = document.getElementById('input-title');
    const inputText = document.getElementById('input-text');
    const inputUrl = document.getElementById('input-url');

    const shareBtn = document.getElementById('share-btn');
    const copyBtn = document.getElementById('copy-btn');
    const feedbackMessage = document.getElementById('feedback-message');
    const releaseModal = document.getElementById('release-modal');
    const releaseModalBody = document.getElementById('release-modal-body');
    const releaseModalTitle = document.getElementById('release-modal-title');
    const releaseModalVersion = document.getElementById('release-modal-version');
    const releaseModalClose = document.getElementById('release-modal-close');
    const releaseModalCta = document.getElementById('release-modal-cta');

    // Modal dismissal handler
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'dismiss-modal') {
        hideDeviceModal();
      }
    });

    if (releaseModalClose) {
      releaseModalClose.addEventListener('click', () => closeReleaseModal());
    }

    if (releaseModalCta) {
      releaseModalCta.addEventListener('click', () => closeReleaseModal());
    }

    if (releaseModal) {
      releaseModal.addEventListener('click', (event) => {
        if (event.target === releaseModal) {
          closeReleaseModal();
        }
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && releaseModal && !releaseModal.classList.contains('hidden')) {
        closeReleaseModal();
      }
    });

    // Mobile help banner logic
    function shouldShowMobileHelp() {
      try {
        return isAndroidMobile() && !isSharedContent() && !localStorage.getItem('mobileHelpDismissed');
      } catch (e) {
        console.warn('localStorage not available for mobile help check:', e);
        return isAndroidMobile() && !isSharedContent();
      }
    }

    function showMobileHelp() {
      const banner = document.getElementById('mobile-help-banner');
      if (banner) {
        banner.classList.remove('hidden');
      }
    }

    function hideMobileHelp() {
      const banner = document.getElementById('mobile-help-banner');
      if (banner) {
        banner.classList.add('hidden');
        try {
          localStorage.setItem('mobileHelpDismissed', 'true');
        } catch (e) {
          console.warn('localStorage not available for dismissing mobile help:', e);
        }
      }
    }

    // Mobile help dismiss handler
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'dismiss-mobile-help') {
        hideMobileHelp();
      }
    });


    // Template selection    // Migrate old template IDs in localStorage
    function migrateTemplateIds() {
      try {
        const stored = localStorage.getItem('shareforge-template-order');
        if (stored) {
          const order = JSON.parse(stored);
          const migrated = order.map(id => {
            if (id === 'telegram') return 'chat';
            if (id === 'telegram-en') return 'chat-en';
            return id;
          });
          localStorage.setItem('shareforge-template-order', JSON.stringify(migrated));
          console.log('Migrated template IDs:', order, '->', migrated);
        }
      } catch (e) {
        console.warn('Error migrating template IDs:', e);
      }
    }

    // Initialize
    function init() {
      bootstrapStaticData();

      // Migrate old template IDs if needed
      migrateTemplateIds();

      // Initialize i18n first
      updateI18n();

      // Check if content was shared
      if (isSharedContent()) {
        currentData = parseSharedData();
        populateInputs();
        clearSharedDataFromUrl();
      }

      // Load templates into select
      loadTemplates();

      // Update preview
      updatePreview();

      // Show/hide share button based on API availability
      if (shareBtn && !canShare()) {
        shareBtn.style.display = 'none';
      }

      // Update share buttons state based on URL
      updateShareButtonsState();

      // Show mobile help banner if needed
      if (shouldShowMobileHelp()) {
        showMobileHelp();
      }
    }

    // Load templates as buttons with drag-and-drop support
    function loadTemplates() {
      if (!templateButtons) return;
      templateButtons.innerHTML = '';

      // Get custom order from localStorage
      const order = getTemplateOrder(DEFAULT_TEMPLATES);
      orderedTemplates = order.map(id => DEFAULT_TEMPLATES.find(t => t.id === id)).filter(t => t);

      orderedTemplates.forEach((template, index) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'template-btn flex flex-col items-center justify-center p-4 rounded-xl bg-gray-50 border-2 border-gray-200 text-gray-800 font-medium shadow-sm hover:bg-gray-100 active:bg-gray-200 transition-colors';
        button.dataset.templateId = template.id;
        button.draggable = true;

        // SECURITY NOTE: innerHTML is used here to render template data.
        // Template data comes from templates.yaml (build time) - a trusted source.
        // The emoji and name fields are hardcoded in YAML and validated at build.
        button.innerHTML = `
          <span class="text-3xl mb-2">${template.emoji}</span>
          <span class="text-sm text-center">${template.name}</span>
        `;

        button.addEventListener('click', () => selectTemplate(template.id));

        // Drag event handlers
        button.addEventListener('dragstart', (e) => {
          draggedElement = button;
          button.style.opacity = '0.5';
          e.dataTransfer.effectAllowed = 'move';
        });

        button.addEventListener('dragend', (e) => {
          draggedElement = null;
          button.style.opacity = '1';
        });

        button.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          if (draggedElement && draggedElement !== button) {
            // Swap elements in DOM
            const allButtons = Array.from(templateButtons.querySelectorAll('.template-btn'));
            const draggedIndex = allButtons.indexOf(draggedElement);
            const targetIndex = allButtons.indexOf(button);

            if (draggedIndex < targetIndex) {
              button.parentNode.insertBefore(draggedElement, button.nextSibling);
            } else {
              button.parentNode.insertBefore(draggedElement, button);
            }
          }
        });

        button.addEventListener('drop', (e) => {
          e.preventDefault();
        });

        templateButtons.appendChild(button);
      });

      // Save reordered templates on any change
      templateButtons.addEventListener('dragend', () => {
        const newOrder = Array.from(templateButtons.querySelectorAll('.template-btn'))
          .map(btn => btn.dataset.templateId);
        saveTemplateOrder(newOrder);
      });
    }

    // Select a template
    function selectTemplate(templateId) {
      currentTemplateId = templateId;
      updateButtonStyles();
      updatePreview();
    }

    // Update button styles based on selection
    function updateButtonStyles() {
      if (!templateButtons) return;
      const buttons = templateButtons.querySelectorAll('.template-btn');
      buttons.forEach(button => {
        const isSelected = button.dataset.templateId === currentTemplateId;
        if (isSelected) {
          button.classList.remove('bg-gray-50', 'border-gray-200', 'text-gray-800');
          button.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
        } else {
          button.classList.remove('bg-blue-50', 'border-blue-200', 'text-blue-800');
          button.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-800');
        }
      });
    }

    // Get template by ID
    function getTemplate(id) {
      return DEFAULT_TEMPLATES.find(t => t.id === id);
    }

    // Populate input fields with current data
    function populateInputs() {
      if (!inputTitle || !inputText || !inputUrl) return;
      isPopulating = true;
      inputTitle.value = currentData.title;
      inputText.value = currentData.text;
      inputUrl.value = currentData.url;
      isPopulating = false;
      updateShareButtonsState();
    }

    // Update current data from inputs
    function updateDataFromInputs() {
      if (!inputTitle || !inputText || !inputUrl) return;
      currentData = {
        title: inputTitle.value,
        text: inputText.value,
        url: inputUrl.value
      };
    }

    // Update preview text
    function updatePreview() {
      if (!previewText || !charCount || !appendUrlCheckbox) return;
      let result = '';

      if (currentTemplateId) {
        // Apply selected template
        const template = getTemplate(currentTemplateId);
        if (!template) return;

        const appendUrl = appendUrlCheckbox.checked;
        result = applyTemplate(template.template, currentData, appendUrl);
      } else {
        // Free text mode - combine non-empty fields
        const parts = [];
        if (currentData.title) parts.push(currentData.title);
        if (currentData.text) parts.push(currentData.text);

        result = parts.join('\n\n');

        // Add URL if checkbox is checked and URL is provided
        if (appendUrlCheckbox.checked && currentData.url) {
          result = result ? result + '\n\n' + currentData.url : currentData.url;
        }
      }

      previewText.value = result;
      charCount.textContent = t('preview.charCount', { count: result.length });
    }

    // Show feedback message
    function showFeedback(message, type = 'success') {
      if (!feedbackMessage) return;
      feedbackMessage.textContent = message;
      feedbackMessage.className = `mt-4 p-3 rounded-lg ${
        type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
      }`;
      feedbackMessage.classList.remove('hidden');

      setTimeout(() => {
        if (feedbackMessage) {
          feedbackMessage.classList.add('hidden');
        }
      }, 3000);
    }

    // Update share buttons state based on URL presence
    function updateShareButtonsState() {
      const hasUrl = currentData.url && currentData.url.trim() !== '';

      if (shareBtn) {
        shareBtn.disabled = !hasUrl;
        if (!hasUrl) {
          shareBtn.classList.add('opacity-50', 'cursor-not-allowed');
          shareBtn.classList.remove('hover:bg-blue-600', 'hover:shadow-md');
        } else {
          shareBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          shareBtn.classList.add('hover:bg-blue-600', 'hover:shadow-md');
        }
      }

      if (copyBtn) {
        copyBtn.disabled = !hasUrl;
        if (!hasUrl) {
          copyBtn.classList.add('opacity-50', 'cursor-not-allowed');
          copyBtn.classList.remove('hover:bg-gray-600', 'hover:shadow-md');
        } else {
          copyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          copyBtn.classList.add('hover:bg-gray-600', 'hover:shadow-md');
        }
      }
    }


    // Event listeners

    if (inputTitle) {
      inputTitle.addEventListener('input', () => {
        if (!isPopulating) {
          updateDataFromInputs();
          updatePreview();
        }
      });
    }

    if (inputText) {
      inputText.addEventListener('input', () => {
        if (!isPopulating) {
          updateDataFromInputs();
          updatePreview();
        }
      });
    }

    if (inputUrl) {
      inputUrl.addEventListener('input', () => {
        if (!isPopulating) {
          updateDataFromInputs();
          updatePreview();
          updateShareButtonsState();
        }
      });
    }

    if (appendUrlCheckbox) {
      appendUrlCheckbox.addEventListener('change', updatePreview);
    }

    if (shareBtn) {
      shareBtn.addEventListener('click', async () => {
        const text = previewText.value;
        if (!text) {
          showFeedback(t('feedback.noTextToShare'), 'error');
          return;
        }

        const success = await shareText(text, 'ShareForge');
        if (success) {
          showFeedback(t('feedback.shareSuccess'));
        } else {
          // Fallback to copy
          const copied = await copyToClipboard(text);
          if (copied) {
            showFeedback(t('feedback.shareUnavailable'));
          } else {
            showFeedback(t('feedback.shareError'), 'error');
          }
        }
      });
    }

    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const text = previewText.value;
        if (!text) {
          showFeedback(t('feedback.noTextToCopy'), 'error');
          return;
        }

        const success = await copyToClipboard(text);
        if (success) {
          showFeedback(t('feedback.copySuccess'));
        } else {
          showFeedback(t('feedback.copyError'), 'error');
        }
      });
    }

    // Menu toggle
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');

    if (menuBtn && menuDropdown) {
      menuBtn.addEventListener('click', () => {
        menuDropdown.classList.toggle('hidden');
      });

      // Close menu when clicking a link
      menuDropdown.addEventListener('click', (e) => {
        if (e.target && e.target.tagName === 'A') {
          menuDropdown.classList.add('hidden');
        }
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (e.target && !e.target.closest('header')) {
          menuDropdown.classList.add('hidden');
        }
      });
    }

    // Reset templates order button
    const resetTemplatesBtn = document.getElementById('reset-templates-btn');
    if (resetTemplatesBtn) {
      resetTemplatesBtn.addEventListener('click', () => {
        resetTemplateOrder();
        loadTemplates();
        showFeedback(t('templateSection.resetFeedback'));
      });
    }

    // Initialize app once DOM is ready so inline data globals exist
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        try {
          init();
        } catch (error) {
          console.error('Error during app initialization:', error);
        }
      });
    } else {
      try {
        init();
      } catch (error) {
        console.error('Error during app initialization:', error);
      }
    }
  </script>
</body>
</html>
