const N="riformula-templates",y=[{id:"simple",name:"Semplice",template:`{title}

{text}

{url}`},{id:"formal",name:"Formale",template:`Ho trovato questo contenuto interessante:

"{title}"

{text}

Maggiori informazioni: {url}`},{id:"brief",name:"Breve",template:"{title} - {url}"}];function l(){if(typeof localStorage>"u")return y;try{const e=localStorage.getItem(N);return e?JSON.parse(e):(v(y),y)}catch(e){return console.error("Error loading templates:",e),y}}function v(e){if(typeof localStorage>"u")return!1;try{return localStorage.setItem(N,JSON.stringify(e)),!0}catch(t){return console.error("Error saving templates:",t),!1}}function x(e){return l().find(n=>n.id===e)}function $(e,t){const n=l(),r={id:`custom-${Date.now()}`,name:e,template:t};return n.push(r),v(n),r}function j(e,t,n){const r=l(),i=r.findIndex(c=>c.id===e);return i===-1?!1:(r[i]={...r[i],name:t,template:n},v(r),!0)}function J(e){const t=l(),n=t.filter(r=>r.id!==e);return n.length===t.length?!1:(v(n),!0)}function z(e,t,n=!0){const{title:r="",text:i="",url:c=""}=t;let d=e.replace(/\{title\}/g,r).replace(/\{text\}/g,i).replace(/\{url\}/g,c);return n&&c&&!e.includes("{url}")&&(d=d.trim()+`

`+c),d}function H(){const e=l(),t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download="riformula-templates.json",i.click(),URL.revokeObjectURL(r)}async function _(e){return new Promise((t,n)=>{const r=new FileReader;r.onload=i=>{try{const c=JSON.parse(i.target.result);if(!Array.isArray(c))throw new Error("Invalid format: must be an array");const d=l(),P=new Set(d.map(u=>u.id)),C=c.filter(u=>u.id&&u.name&&u.template&&!P.has(u.id)),W=[...d,...C];v(W),t(C.length)}catch(c){n(c)}},r.onerror=()=>n(r.error),r.readAsText(e)})}function A(){return typeof navigator<"u"&&typeof navigator.share=="function"}async function q(e,t="Riformula"){if(!A())return console.log("Web Share API not available"),!1;try{return await navigator.share({title:t,text:e}),!0}catch(n){return n.name!=="AbortError"&&console.error("Error sharing:",n),!1}}async function M(e){if(typeof navigator<"u"&&navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),!0}catch(t){console.error("Error copying to clipboard:",t)}if(typeof document<"u")try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();const n=document.execCommand("copy");return document.body.removeChild(t),n}catch(t){return console.error("Error copying to clipboard (fallback):",t),!1}return!1}function G(){if(typeof window>"u")return{title:"",text:"",url:""};const e=new URLSearchParams(window.location.search);return{title:e.get("title")||"",text:e.get("text")||"",url:e.get("url")||""}}function K(){if(typeof window>"u")return!1;const e=new URLSearchParams(window.location.search);return e.has("title")||e.has("text")||e.has("url")}function Y(){if(typeof window>"u"||typeof history>"u")return;const e=new URL(window.location.href);e.search="",history.replaceState({},"",e)}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e)}).catch(e=>{console.error("Service Worker registration failed:",e)})});let a=null,m={title:"",text:"",url:""},h=null;const p=document.getElementById("template-select"),b=document.getElementById("preview-text"),Q=document.getElementById("char-count"),O=document.getElementById("append-url-checkbox"),B=document.getElementById("input-title"),L=document.getElementById("input-text"),I=document.getElementById("input-url"),V=document.getElementById("new-template-btn"),X=document.getElementById("edit-template-btn"),Z=document.getElementById("delete-template-btn"),ee=document.getElementById("export-templates-btn"),U=document.getElementById("import-templates-input"),D=document.getElementById("share-btn"),te=document.getElementById("copy-btn"),E=document.getElementById("feedback-message"),f=document.getElementById("template-editor-modal"),R=document.getElementById("editor-title"),w=document.getElementById("template-name"),T=document.getElementById("template-content"),ne=document.getElementById("save-template-btn"),re=document.getElementById("cancel-editor-btn");function oe(){K()&&(m=G(),ae(),Y()),g(),s(),A()||(D.style.display="none")}function g(){const e=l();p.innerHTML="",e.forEach((t,n)=>{const r=document.createElement("option");r.value=t.id,r.textContent=t.name,p.appendChild(r),n===0&&(a=t.id)})}function ae(){B.value=m.title,L.value=m.text,I.value=m.url}function S(){m={title:B.value,text:L.value,url:I.value}}function s(){const e=x(a);if(!e)return;const t=O.checked,n=z(e.template,m,t);b.value=n,Q.textContent=`${n.length} caratteri`}function o(e,t="success"){E.textContent=e,E.className=`mt-4 p-3 rounded-lg ${t==="success"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,E.classList.remove("hidden"),setTimeout(()=>{E.classList.add("hidden")},3e3)}function F(e,t=null){if(h=e,e==="new")R.textContent="Nuovo Template",w.value="",T.value="";else if(e==="edit"&&t){const n=x(t);n&&(R.textContent="Modifica Template",w.value=n.name,T.value=n.template)}f.classList.remove("hidden"),f.classList.add("flex")}function k(){f.classList.add("hidden"),f.classList.remove("flex")}function ie(){const e=w.value.trim(),t=T.value.trim();if(!e||!t){alert("Nome e contenuto sono obbligatori");return}h==="new"?(a=$(e,t).id,g(),p.value=a,o("Template creato con successo")):h==="edit"&&(j(a,e,t)?(g(),p.value=a,o("Template aggiornato con successo")):o("Errore durante l'aggiornamento","error")),s(),k()}p.addEventListener("change",e=>{a=e.target.value,s()});B.addEventListener("input",()=>{S(),s()});L.addEventListener("input",()=>{S(),s()});I.addEventListener("input",()=>{S(),s()});O.addEventListener("change",s);V.addEventListener("click",()=>{F("new")});X.addEventListener("click",()=>{a&&F("edit",a)});Z.addEventListener("click",()=>{if(!a)return;const e=x(a);e&&confirm(`Eliminare il template "${e.name}"?`)&&(J(a)?(g(),a=p.value,s(),o("Template eliminato con successo")):o("Errore durante l'eliminazione","error"))});ee.addEventListener("click",()=>{H(),o("Template esportati con successo")});U.addEventListener("change",async e=>{const t=e.target.files[0];if(t){try{const n=await _(t);g(),o(`Importati ${n} template`)}catch(n){o("Errore durante l'importazione: "+n.message,"error")}U.value=""}});ne.addEventListener("click",ie);re.addEventListener("click",k);f.addEventListener("click",e=>{e.target===f&&k()});D.addEventListener("click",async()=>{const e=b.value;if(!e){o("Nessun testo da condividere","error");return}await q(e,"Riformula")?o("Testo condiviso con successo"):await M(e)?o("Condivisione non disponibile. Testo copiato negli appunti"):o("Errore durante la condivisione","error")});te.addEventListener("click",async()=>{const e=b.value;if(!e){o("Nessun testo da copiare","error");return}await M(e)?o("Testo copiato negli appunti"):o("Errore durante la copia","error")});oe();
